<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PropertiesSourceHoconImpl.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">maxur-mserv-core</a> &gt; <a href="index.source.html" class="el_package">org.maxur.mserv.core.service.properties</a> &gt; <span class="el_source">PropertiesSourceHoconImpl.kt</span></div><h1>PropertiesSourceHoconImpl.kt</h1><pre class="source lang-java linenums">@file:Suppress(&quot;unused&quot;)

package org.maxur.mserv.core.service.properties

import com.fasterxml.jackson.databind.ObjectMapper
import com.jasonclawson.jackson.dataformat.hocon.HoconFactory
import com.typesafe.config.Config
import com.typesafe.config.ConfigException
import com.typesafe.config.ConfigFactory
import org.jvnet.hk2.annotations.Service
import org.maxur.mserv.core.service.jackson.ObjectMapperProvider
import org.maxur.mserv.core.utils.Either
import org.maxur.mserv.core.utils.either
import java.io.File
import java.io.IOException
import java.net.URI
import java.nio.file.Paths
import java.time.Duration

@Service(name = &quot;Hocon&quot;)
<span class="nc" id="L21">class PropertiesFactoryHoconImpl : PropertiesFactory() {</span>
    override fun make(source: PropertiesSource): Either&lt;Exception, Properties&gt; =
<span class="nc" id="L23">            either { PropertiesSourceHoconImpl(source) }</span>
}

<span class="nc" id="L26">internal class PropertiesSourceHoconImpl(private val rawSource: PropertiesSource)</span>
<span class="nc bnc" id="L27" title="All 2 branches missed.">    : Properties, PropertiesSource(&quot;Hocon&quot;, rootKey = rawSource.rootKey ?: &quot;DEFAULTS&quot;) {</span>

<span class="nc" id="L29">    private var root: Config = try {</span>
<span class="nc" id="L30">        rootNode().getConfig(rootKey)</span>
<span class="nc" id="L31">    } catch(e: ConfigException.Missing) {</span>
<span class="nc" id="L32">        throw IllegalStateException(&quot;The properties source '$uri' not found. &quot; +</span>
<span class="nc bnc" id="L33" title="All 2 branches missed.">                &quot;You need create one with '${rootKey ?: &quot;/&quot;}' section&quot;)</span>
    }

<span class="nc bnc" id="L36" title="All 6 branches missed.">    override val uri: URI? get() = root.origin()?.url()?.toURI() ?: rawSource.uri</span>

<span class="nc" id="L38">    private val mapper = ObjectMapperProvider.config(ObjectMapper(HoconFactory()))</span>

    private fun rootNode(): Config =
<span class="nc bnc" id="L41" title="All 2 branches missed.">            if (rawSource.uri == null)</span>
<span class="nc" id="L42">                ConfigFactory.load()</span>
            else {
<span class="nc bnc" id="L44" title="All 2 branches missed.">                val uri: URI  = rawSource.uri!!</span>
<span class="nc bnc" id="L45" title="All 9 branches missed.">                when (uri.scheme) {</span>
<span class="nc" id="L46">                    null -&gt; loadFrom(File(uri.toString()))</span>
<span class="nc" id="L47">                    &quot;file&quot; -&gt; loadFrom(Paths.get(uri).toFile())</span>
<span class="nc" id="L48">                    &quot;classpath&quot; -&gt; ConfigFactory.load(uri.withoutScheme())</span>
<span class="nc" id="L49">                    else -&gt; throw IllegalArgumentException(</span>
<span class="nc" id="L50">                            &quot;Unsupported schema '${uri.scheme}' to properties source. &quot; +</span>
                                    &quot;Must be one of [file, classpath]&quot;
                    )
                }
<span class="nc" id="L54">            }</span>


    @Suppress(&quot;UNCHECKED_CAST&quot;)
    override fun &lt;P&gt; read(key: String, clazz: Class&lt;P&gt;): P? =
<span class="nc" id="L59">            when (clazz) {</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">                String::class.java -&gt; asString(key) as P?</span>
<span class="nc bnc" id="L61" title="All 4 branches missed.">                Int::class.java, Integer::class.java -&gt; asInteger(key) as P?</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">                Long::class.java -&gt; asLong(key) as P?</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">                URI::class.java -&gt; asURI(key) as P?</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">                Double::class.java -&gt; root.getDouble(key) as P?</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                Duration::class.java -&gt; root.getDuration(key) as P?</span>
<span class="nc" id="L66">                else -&gt; asObject(key, clazz) as P?</span>
<span class="nc" id="L67">            }</span>

    private fun loadFrom(file: File): Config =
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (!file.exists())</span>
<span class="nc" id="L71">                throw IllegalArgumentException(&quot;Properties file '${file.absolutePath}' is not found&quot;)</span>
            else
<span class="nc" id="L73">                ConfigFactory.parseFile(file)</span>


    override fun asURI(key: String): URI? {
<span class="nc" id="L77">        val string = asString(key)</span>
<span class="nc" id="L78">        return when (string) {</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">            null -&gt; null</span>
<span class="nc" id="L80">            else -&gt; URI.create(string)</span>
        }
    }

    private fun asObject(key: String, clazz: Class&lt;*&gt;): Any? {
<span class="nc" id="L85">        try {</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            return getValue(key, { it.getObject(key) })</span>
<span class="nc" id="L87">                    ?.let { mapper.readValue(it.render(), clazz) }</span>
<span class="nc" id="L88">        } catch (e: Exception) {</span>
<span class="nc" id="L89">            when (e) {</span>
<span class="nc bnc" id="L90" title="All 4 branches missed.">                is IOException, is ConfigException.WrongType -&gt; {</span>
<span class="nc" id="L91">                    throw IllegalStateException(&quot;Configuration parameter '$key' is not parsed.&quot;, e)</span>
                }
<span class="nc" id="L93">                else -&gt; throw e</span>
            }
        }
    }

<span class="nc" id="L98">    override fun asString(key: String): String? = getValue(key, { it.getString(key) })</span>
<span class="nc" id="L99">    override fun asLong(key: String): Long? = getValue(key, { it.getLong(key) })</span>
<span class="nc" id="L100">    override fun asInteger(key: String): Int? = getValue(key, { it.getInt(key) })</span>

    private fun &lt;T&gt; getValue(key: String, transform: (Config) -&gt; T?): T? =
<span class="nc" id="L103">            try {</span>
<span class="nc" id="L104">                root.let { transform.invoke(it) }</span>
<span class="nc" id="L105">            } catch (e: ConfigException.Missing) {</span>
<span class="nc" id="L106">                throw IllegalStateException(&quot;Configuration parameter '$key' is not found.&quot;, e)</span>
<span class="nc" id="L107">            }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>